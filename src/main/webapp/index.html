<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gateway SIBS Testes</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"></linkhref>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.1/mdb.min.css" />

  
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f0f0f0;
            color: #333;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        * {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .navbar {
            background-color: #fff !important;
            padding-top: 0.3rem;
            padding-bottom: 0.3rem;
            min-height: 85px;
        }
        .navbar .navbar-brand img {
            max-height: 65px;
            width: auto;
        }

        .navbar .navbar-brand,
      

        footer {
            background-color: #fff;
            color: #333;
            padding: 20px 0;
            font-size: 0.9rem;
            text-align: center;
        }

        footer a.btn {
            font-size: 0.85rem;
            padding: 6px 14px;
        }

        footer a {
            color: #4c1d95;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        main {
            flex: 1;
        }

        h2{
            font-family: "Montserrat";
            font-weight: bold;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://www.sibs.com/wp-content/themes/sitesibs/assets/images/logo.png" alt="Logo SIBS" style="width: 140px;">
                <span class="text-white"></span>
            </a>
            
            <div class="ms-auto">
                <a href="http://localhost:8080/webapp/config.html" class="btn btn-secondary btn-rounded" data-mdb-ripple-init><i class="fa fa-gears"></i> Config</a>
            </div>
        </div>
    </nav>

    <main>
        <div class="container mt-4">
            <br>
            <h1 class="text-center mb-4"></h1>

            <div class="card">
                <div class="card-header text-center" style="background-color: #cae3ff;">
                    <br>
                    <h2 style="color: #454545;"><b>Gateway SIBS Testes</b></h2>                
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Valor (€):</label>
                        <input type="number" id="amount" class="form-control" value="1" min="1" step="0.01" onchange="makePayment()">
                    </div>

                    <div class="mb-3">
                        <label for="payment-method" class="form-label">Método de Pagamento:</label>
                        <select id="payment-method" class="form-select" onchange="makePayment()">
                            <option value="CARD">Cartão</option>
                            <option value="MBWAY">MB WAY</option>
                            <option value="REFERENCE">Referência</option>
                        </select>
                    </div>

                    <button class="btn btn-primary w-100" onclick="makePayment()">Iniciar Pagamento</button>
                </div>
            </div>

            <div id="payment-form" class="mt-4"></div>
        </div>
        <br>
    </main>

    <footer>
        <div class="container">
            <p class="mb-1">© 2025 Pagamentos SIBS. Todos os direitos reservados.</p>
            <a href="https://www.docs.pay.sibs.com/portugal/sibs-gateway/integrations/api/integration-guide/" 
               class="btn btn-secondary btn-rounded" data-mdb-ripple-init style="color: #333 !important;">
               Visite aqui a documentação da Gateway
            </a>
        </div>
    </footer>

    <script>
        async function makePayment() {
            const apiUrl = "https://spg.qly.site1.sibs.pt/api/v2/payments";
            const token = "0276b80f950fb446c6addaccd121abfbbb.eyJlIjoiMjA1ODA5Nzc5Nzc3MyIsInJvbGVzIjoiTUFOQUdFUiIsInRva2VuQXBwRGF0YSI6IntcIm1jXCI6XCIzNjkwMDZcIixcInRjXCI6XCI4MDc2MFwifSIsImkiOiIxNzQyNTY0OTk3NzczIiwiaXMiOiJodHRwczovL3FseS5zaXRlMS5zc28uc3lzLnNpYnMucHQvYXV0aC9yZWFsbXMvUUxZLk1FUkNILlBPUlQxIiwidHlwIjoiQmVhcmVyIiwiaWQiOiJGRXZCOTh6WHMyMzU4NzE5MDFjYzkxNDRkMTgzZTc2MDQ1NWUzMmYzYmMifQ==.a58e334057e8e792127de95c6c12d41ba7fcd42361d7ef2ea87749a276192ead72ccfda4a98091f192bd7b3576e27d39b27c1e972d1b34a761540400535ea193";
            const clientId = "9bbac851-6948-4c4e-9145-b45ef913f8d3";
            const amountValue = parseFloat(document.getElementById("amount").value);
            const selectedMethod = document.getElementById("payment-method").value;

            if (!selectedMethod) {
                alert("Selecione um método de pagamento.");
                return;
            }

            const requestData = {
                merchant: {
                    terminalId: 80760,
                    channel: "web",
                    merchantTransactionId: "OrderID_00000"
                },
                transaction: {
                    transactionTimestamp: new Date().toISOString(),
                    description: "Transaction short description",
                    moto: false,
                    paymentType: "PURS",
                    amount: {
                        value: amountValue,
                        currency: "EUR"
                    },
                    paymentMethod: [selectedMethod],
                    paymentReference: { 
                        initialDatetime: new Date().toISOString(),
                        finalDatetime: "2025-06-30T23:59:59.000Z",
                        maxAmount: {
                            value: amountValue,
                            currency: "EUR"
                        },
                        minAmount: {
                            value:amountValue,
                            currency: "EUR"
                        },
                        entity: "53246"
                    },
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "X-IBM-Client-Id": clientId,
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.status}`);
                }

                const data = await response.json();
                if (data.transactionID && data.formContext) {
                    generatePaymentForm(data.transactionID, data.formContext, selectedMethod);
                } else {
                    throw new Error("Resposta da API incompleta.");
                }
            } catch (error) {
                console.error("Erro ao processar pagamento:", error);
                alert("Erro ao processar pagamento. Verifique o console para mais detalhes.");
            }
        }

        function generatePaymentForm(transactionID, formContext, selectedMethod) {
            const script = document.createElement("script");
            script.src = `https://spg.qly.site1.sibs.pt/assets/js/widget.js?id=${transactionID}`;
            document.body.appendChild(script);

            const formContainer = document.getElementById("payment-form");
            formContainer.innerHTML = "";
            
            let redirectUrl = "http://localhost:8080/webapp/REFERENCE_return.html";

            if (selectedMethod === "MBWAY") {
                redirectUrl = "http://localhost:8080/webapp/MBWAY_return.html";
            }

            if (selectedMethod === "CARD") {
                redirectUrl = "http://localhost:8080/webapp/card_return.html";
            }

            const form = document.createElement("form");
            form.className = "paymentSPG";
            form.setAttribute("spg-context", formContext);
            form.setAttribute("spg-config", JSON.stringify({
                paymentMethodList: [],
                amount: { value: parseFloat(document.getElementById("amount").value), currency: "EUR" },
                language: "pt",
                redirectUrl: redirectUrl
            }));
            formContainer.appendChild(form);
        }

        console.log("Configuração guardada:", {
            terminalId,
            clientId,
            bearerToken,
            paymentMethods: selectedMethods
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.1/mdb.min.js"></script>

</body>
</html>
